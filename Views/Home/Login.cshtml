@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Book2Enter | Login</title>

    <style>
        :root {
            --primary: #00ffcc;
            --card: #111;
            --muted: #aaa;
            --error: #ff6b6b;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            height: 100vh;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            font-family: "Segoe UI", sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .login-card {
            width: 380px;
            background: var(--card);
            padding: 25px;
            border-radius: 14px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,.6);
            animation: fadeIn .8s ease;
        }

        @@keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* LOGO BOX */
        .logo-box {
            width: 110px;
            height: 110px;
            margin: 0 auto 14px;
            position: relative;
            border-radius: 50%;
            overflow: hidden;

            /* NEON BORDER */
            border: 2px solid var(--primary);
            box-shadow:
                0 0 8px rgba(0,255,204,.6),
                0 0 18px rgba(0,255,204,.4),
                inset 0 0 8px rgba(0,255,204,.3);
        }

        .logo-box img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;

            /* SLIGHT ZOOM */
            transform: scale(1.08);

            /* LOCKED STATE */
            filter: grayscale(1) blur(3px);
            transition: filter .6s ease, transform .6s ease;
        }

        /* UNLOCKED STATE */
        .logo-box.unlocked img {
            filter: none;
            transform: scale(1.12); /* tiny extra zoom on unlock */
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--primary);
            box-shadow: 0 0 15px var(--primary);
            display: none;
        }

        /* INPUTS */
        input {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border-radius: 7px;
            border: 2px solid transparent;
            background: #1b1b1b;
            color: white;
            font-size: 15px;
            transition: .3s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0,255,204,.4);
            transform: scale(1.02);
        }

        input.error {
            border-color: var(--error);
            animation: shake .35s;
        }

        @@keyframes shake {
            0%   { transform: translateX(0); }
            25%  { transform: translateX(-5px); }
            50%  { transform: translateX(5px); }
            75%  { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        /* BUTTON */
        button.main {
            width: 100%;
            margin-top: 15px;
            padding: 12px;
            border: none;
            border-radius: 7px;
            background: var(--primary);
            color: #000;
            font-size: 16px;
            cursor: pointer;
        }

        button.main:hover {
            background: #00d6ad;
        }

        .forgot {
            font-size: 14px;
            color: var(--muted);
            display: block;
            margin-top: 8px;
            text-align: right;
            text-decoration: none;
        }

        .forgot:hover { color: var(--primary); }

        .error-text {
            margin-top: 8px;
            color: var(--error);
            display: none;
        }

        .otp-box,
        .change-box {
            display: none;
        }

        /* OTP input grid */
        .otp-grid { display:flex; gap:8px; justify-content:center; margin:12px 0; }
        .otp-grid input { width:44px; height:44px; text-align:center; font-size:18px; border-radius:8px; border:2px solid transparent; background:#1b1b1b; color:white; }
        .otp-grid input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 10px rgba(0,255,204,.3); transform:scale(1.02); }
        .otp-grid input::placeholder { opacity:.4; }
    </style>
</head>

<body>

<div class="login-card">

    <!-- LOGO WITH NEON BORDER + SCAN -->
    <div id="logoBox" class="logo-box">
        <img src="@Url.Content("~/images/B2E_Logo_Final.jpg")"
             alt="Book2Enter Logo" />
        <div id="scanLine" class="scan-line"></div>
    </div>

    <h2>Book2Enter</h2>
    <p style="font-size:13px;opacity:.7">QR-Based Event Entry System</p>

    <!-- LOGIN -->
    <div id="loginBox">
        <input id="userId" type="text" placeholder="User ID" />
        <input id="password" type="password" placeholder="Password" />
        <button class="main" id="loginBtn">Login</button>
        <a href="#" id="forgotLink" class="forgot">Forgot Password?</a>
        <div class="error-text" id="errLogin"></div>
    </div>

    <!-- OTP -->
    <div class="otp-box" id="otpBox">
        <h4 style="margin:0 0 10px 0;">Enter OTP</h4>
        <div class="otp-grid" id="otpGrid">
            <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input" data-index="0" />
            <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input" data-index="1" />
            <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input" data-index="2" />
            <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input" data-index="3" />
            <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input" data-index="4" />
            <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input" data-index="5" />
        </div>
        <button class="main" id="verifyOtpBtn">Verify OTP</button>
        <div class="error-text" id="errOtp"></div>
        <a href="#" id="backToLoginFromOtp" class="forgot" style="display:block;margin-top:8px;text-align:left">Back to Login</a>
    </div> 

    <!-- CHANGE PASSWORD -->
    <div class="change-box" id="changeBox">
        <h4 style="margin:0 0 10px 0;">Reset Password</h4>
        <input id="newPass" type="password" placeholder="New Password" />
        <input id="confirmPass" type="password" placeholder="Confirm Password" />
        <button class="main" id="changePassBtn">Set Password</button>
        <div class="error-text" id="errChange"></div>
        <a href="#" id="backToLogin" class="forgot" style="display:block;margin-top:8px;text-align:left">Back to Login</a>
    </div>

</div>

<script>
    let currentUser = null;
    let otpPurpose = null; // 'firstLogin' or 'forgot'

    function animateScan() {
        const scan = document.getElementById('scanLine');
        const logo = document.getElementById('logoBox');

        scan.style.display = 'block';

        scan.animate(
            [{ top: '0' }, { top: '104px' }],
            { duration: 1200 }
        );

        setTimeout(() => {
            scan.style.display = 'none';
            logo.classList.add('unlocked');
        }, 1200);
    }

    async function postJson(url, data) {
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        return res.json();
    }

    // Normal login flow (existing)
    loginBtn.onclick = async () => {
        const uid = userId.value.trim();
        const pwd = password.value;

        if (!uid || !pwd) {
            errLogin.textContent = 'Enter User ID and Password';
            errLogin.style.display = 'block';
            return;
        }

        animateScan();

        setTimeout(async () => {
            const res = await postJson('/Home/LoginAjax', {
                UserId: uid,
                Password: pwd
            });

            if (!res.success) {
                errLogin.textContent = res.message || 'Invalid credentials';
                errLogin.style.display = 'block';
                return;
            }

            if (res.requiresOtp) {
                currentUser = uid;
                otpPurpose = 'firstLogin';
                loginBox.style.display = 'none';
                otpBox.style.display = 'block';
            } else {
                window.location.href = res.redirectUrl;
            }
        }, 600);
    };

    // Forgot password flow (Send OTP -> Verify -> Reset)
    forgotLink.onclick = async (e) => {
        e.preventDefault();
        const uid = userId.value.trim();
        if (!uid) {
            errLogin.textContent = 'Enter your User ID to reset password';
            errLogin.style.display = 'block';
            return;
        }

        errLogin.style.display = 'none';
        animateScan();

        setTimeout(async () => {
            const res = await postJson('/Home/SendOtp', { UserId: uid, Purpose: 'forgot' });
            if (!res.success) {
                errLogin.textContent = res.message || 'Unable to send OTP';
                errLogin.style.display = 'block';
                return;
            }

            currentUser = uid;
            otpPurpose = 'forgot';
            loginBox.style.display = 'none';
            otpBox.style.display = 'block';
            // clear and focus the new OTP inputs
            clearOtpInputs();
            setTimeout(() => { if (otpInputs.length) otpInputs[0].focus(); }, 60);
            errOtp.textContent = res.message || 'OTP sent';
            errOtp.style.display = 'block';
            setTimeout(() => errOtp.style.display = 'none', 2500);
        }, 600);
    };

    // OTP helpers: inputs, get/clear values, and keyboard behavior
    const otpInputs = Array.from(document.querySelectorAll('.otp-input'));
    function getOtpVal() { return otpInputs.map(i => i.value).join('').trim(); }
    function clearOtpInputs() { otpInputs.forEach(i => i.value = ''); }

    otpInputs.forEach((input, idx) => {
        input.addEventListener('input', (e) => {
            input.value = input.value.replace(/\D/g, '').slice(0,1);
            if (input.value && idx < otpInputs.length - 1) otpInputs[idx + 1].focus();
        });
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !input.value && idx > 0) {
                otpInputs[idx - 1].focus();
            }
        });
        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const digits = paste.replace(/\D/g, '').slice(0, otpInputs.length);
            digits.split('').forEach((d, i) => otpInputs[i].value = d);
            const focusIndex = Math.min(digits.length, otpInputs.length - 1);
            otpInputs[focusIndex].focus();
        });
    });

    verifyOtpBtn.onclick = async () => {
        const otpVal = getOtpVal();
        if (!otpVal || otpVal.length < otpInputs.length || !currentUser) {
            errOtp.textContent = 'Enter the full 6-digit OTP sent to your email';
            errOtp.style.display = 'block';
            return;
        }

        const res = await postJson('/Home/VerifyOtp', { UserId: currentUser, Otp: otpVal, Purpose: otpPurpose });
        if (!res.success) {
            errOtp.textContent = res.message || 'Invalid or expired OTP';
            errOtp.style.display = 'block';
            return;
        }

        // If this was first login, require password change; if forgot -> allow reset
        if (res.requirePasswordChange || res.allowReset) {
            otpBox.style.display = 'none';
            changeBox.style.display = 'block';
            setTimeout(() => { newPass.focus(); }, 60);
        }
    };

    changePassBtn.onclick = async () => {
        const np = newPass.value;
        const cp = confirmPass.value;
        if (!np || !cp) {
            errChange.textContent = 'Fill in both password fields';
            errChange.style.display = 'block';
            return;
        }
        if (np !== cp) {
            errChange.textContent = 'Passwords do not match';
            errChange.style.display = 'block';
            return;
        }

        const res = await postJson('/Home/ChangePassword', { UserId: currentUser, NewPassword: np });
        if (!res.success) {
            errChange.textContent = res.message || 'Could not change password';
            errChange.style.display = 'block';
            return;
        }

        // On success redirect to appropriate page
        window.location.href = res.redirectUrl || '/';
    };

    // Back-to-login handlers (cancel flows)
    backToLogin.onclick = backToLoginFromOtp.onclick = (e) => {
        e.preventDefault();
        currentUser = null;
        otpPurpose = null;
        loginBox.style.display = 'block';
        otpBox.style.display = 'none';
        changeBox.style.display = 'none';
        userId.value = '';
        password.value = '';
        clearOtpInputs();
        newPass.value = '';
        confirmPass.value = '';
        errLogin.style.display = 'none';
        errOtp.style.display = 'none';
        errChange.style.display = 'none';
    };
</script>

</body>
</html>
